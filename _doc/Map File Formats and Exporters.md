# Map File Formats and Exporters

This document details the different file formats generated by the map exporter and the algorithms used to create them. The exporter is triggered via the `/api/export` endpoint and provides a zip archive containing the map in various formats.

## File Format Details

The application exports the map data into several standard point cloud and mesh formats to ensure compatibility with a wide range of 3D software, such as CloudCompare and Blender.

### PLY (Polygon File Format)

A versatile format for storing 3D data. We generate two ASCII PLY files:

-   **`map-voxels.ply`**: A mesh representation of the map. Each voxel is represented as a cube with 8 vertices and 6 faces. Each vertex has its `x, y, z` coordinates and `red, green, blue` color properties.
-   **`map-points.ply`**: A simple point cloud. Each point corresponds to the center of a voxel and includes its `x, y, z` coordinates and `red, green, blue` color properties.

### PCD (Point Cloud Data)

A file format for storing 3D point cloud data.

-   **`map-points.pcd`**: An ASCII PCD file containing the voxel centers. It stores `x, y, z` coordinates and a single `rgb` field. The individual R, G, and B color values are packed into a single 32-bit float for each point, a standard convention for this format.

### LAZ (Compressed LASer file format)

The LASer (LAS) file format is a public file format for the interchange of 3-dimensional point cloud data. We provide the compressed version, LAZ.

-   **`map-points.laz`**: A compressed binary file containing the voxel centers. It stores `x, y, z` coordinates and RGB color information. The 8-bit color values are scaled to the 16-bit range required by the LAS specification.

## Algorithms

The following outlines the implementation of the exporter functions in `server/main.py`.

### Voxel Mesh PLY (`_generate_voxel_mesh_ply`)

1.  A PLY header is created, defining elements for vertices (with x, y, z, and color properties) and faces.
2.  The function iterates through each voxel in the map data.
3.  For each voxel, it calculates the 8 vertices of a cube centered at the voxel's position. The size of the cube is determined by the voxel's `size` property or the map's overall `resolution`.
4.  Color values are clamped to the `0-255` range.
5.  Vertex coordinates (floats) are formatted to 6 decimal places to ensure consistency.
6.  The 6 faces of the cube are defined using the indices of the 8 vertices.
7.  The vertex and face data are combined with the header to form the final PLY file content.

### Point Cloud PLY (`_generate_points_ply`)

1.  A PLY header is created, defining a list of vertices with `x, y, z` and `red, green, blue` properties.
2.  The function iterates through each voxel.
3.  For each voxel, a single point is created at its center coordinates.
4.  Color values are clamped to the `0-255` range.
5.  Float coordinates are formatted to 6 decimal places.
6.  The resulting lines of vertex data are combined with the header.

### Point Cloud PCD (`_generate_points_pcd`)

1.  A PCD file header is created, specifying the version, fields (`x, y, z, rgb`), size, type, and number of points.
2.  The function iterates through each voxel.
3.  For each voxel, the `x, y, z` coordinates are retrieved.
4.  The R, G, and B color values are clamped to the `0-255` range.
5.  These integer color values are bit-shifted and combined into a single 32-bit integer.
6.  Python's `struct` module is used to pack this integer into 4 bytes and then unpack it as a single-precision float, which is the standard for the `rgb` field in PCD files.
7.  The coordinate and packed RGB float are written as a line in the file, with float coordinates formatted to 6 decimal places.

### Compressed LAS (`_generate_points_las`)

1.  This function utilizes the `laspy` library to create a LAS/LAZ file.
2.  A `LasHeader` is initialized (version 1.4, point format 3, which supports RGB color).
3.  The header's scale is set from the map's resolution, and the offset is set to the minimum coordinates of the point cloud to maintain precision.
4.  Voxel coordinates and colors are read into NumPy arrays for efficient processing.
5.  The 8-bit RGB color values are clamped to `0-255` and then scaled to the 16-bit range (`0-65535`) required by the LAS format by multiplying by 257.
6.  The data is written to an in-memory `io.BytesIO` buffer. The `do_compress=True` flag is used to generate the compressed LAZ format.
